<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.4/angular-material.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet-src.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>
<script src="data/positions.js"></script>   
<script src="hexbin.js"></script>
</head>
        
<body ng-app="feinstaub">
    
<!--    <div layout="column" layout-sm="row" layout-gt-sm ="row" layout-md="row" layout-gt-md="row" >-->

            
<div id ='appcontainer' layout="column">
  <div id ='header' flex="20" layout="row"  layout-wrap ng-cloak>      
        
        <div id ='stadt' ng-controller="StadtCtrl as ctrl" flex="30" ng-cloak>
        <md-content class="md-padding">
        <md-button ng-click="ctrl.openDialog($event)" class="md-raised">Meine Stadt</md-button>
        </md-content>
        </div>
      
        <div id = 'info' ng-controller="InfoCtrl as ctrl" flex="40" ng-cloak>
        <md-content class="md-padding">
        <md-button ng-click="ctrl.openDialog($event)" class="md-raised">Informationen</md-button>
        </md-content>
        </div>
      
        <div id ='sensor' ng-controller="SensorCtrl as ctrl" flex="30" ng-cloak>
        <md-content class="md-padding">
        <md-button ng-click="ctrl.openDialog($event)" class="md-raised">Mein Sensor</md-button>
        </md-content>
        </div>
      
        <div class ='controls' flex="20" ng-cloak>
        <md-content class="md-padding">
        <md-button  id="hmPM10" value="hmPM10" onclick="reload(this.value)" ng-disabled="false" class="md-raised">PM10</md-button>
        </md-content>
        </div>
        <div class ='controls' flex="20" ng-cloak>
        <md-content class="md-padding">
        <md-button  id="hmPM2.5" value="hmPM2.5" onclick="reload(this.value)" ng-disabled="false" class="md-raised">PM2.5</md-button>
        </md-content>
        </div>
        <div class ='controls' flex="20" ng-cloak>
        <md-content class="md-padding">
        <md-button id="hmtemp" value="hmtemp" onclick="reload(this.value)" ng-disabled="false" class="md-raised">Temp.</md-button> 
        </md-content>
        </div>
        <div class ='controls' flex="20" ng-cloak>
        <md-content class="md-padding">
        <md-button id="hmhumi" value="hmhumi" onclick="reload(this.value)" ng-disabled="false" class="md-raised">Feucht.</md-button>
        </md-content>
        </div>
        <div class ='controls' flex="20" ng-cloak>
        <md-content class="md-padding">
        <md-button id="hmdruck" value="hmdruck" onclick="reload(this.value)"  ng-disabled="false" class="md-raised">Druck</md-button>
        </md-content>
        </div>
    
    

    
</div>
    <div id ='map'flex="80">
    
    

    <div id ='legendcontainer'>
        <div class ="legend" id="legendpm">
            <div id="legend-inner-pm">
                <div class="gradient">
                    <div class="limit"></div>
                </div>
                <div class="labels">
                    <div class="label" style="bottom: 100%;"><b>500</b></div>
                    <div class="label" style="bottom: 80%;"><b>100</b></div>
                    <div class="label" style="bottom: 60%;"><b>75</b></div>
                    <div class="label limit" style="bottom: 40%;"><b>50</b></div>
                    <div class="label" style="bottom: 20%;"><b>25</b></div>
                    <div class="label" style="bottom: 0%;"><b>0 &micro;g/m&sup3;</b></div>
                </div>
            </div>
        </div>        
    </div>

       <div class ="legend" id="legendtemp">
<div id="legend-inner-temp">
<div class="gradient">
<div class="limit">
</div>
</div>
<div class="labels">
<div class="label" style="bottom: 100%;"><b>50</b></div>
<div class="label" style="bottom: 65%;"><b>25</b></div>
<div class="label" style="bottom: 30%;"><b>0</b></div>
<div class="label" style="bottom: 0%;"><b>-20 &deg;</b></div>
</div>
</div>
</div>
    
<div class ="legend" id="legendhumi">
<div id="legend-inner-humi">
<div class="gradient">
<div class="limit">
</div>
</div>
<div class="labels">
    <div class="label" style="bottom: 100%;"><b>100</b></div>
    <div class="label" style="bottom: 80%;"><b>80</b></div>
<div class="label" style="bottom: 60%;"><b>60</b></div>
<div class="label " style="bottom: 40%;"><b>40</b></div>
<div class="label" style="bottom: 20%;"><b>20</b></div>
<div class="label" style="bottom: 0%;"><b>0 &#37;</b></div>
</div>
</div>
</div> 
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    </div> 
</div>


    
    
  
<script>
    
    var texte;
    var hmhexaPM =[];
    var hmhexatemp =[];
    var hmhexadruck =[];
    
    var map;
    var tiles;


    var selector = "hmPM10";
    var hexahmtest = false;
    var arraySensors = [];
    var arraySensorsDruck = [];
           
    var mitDruck = false;


 map = L.map('map').setView([48.8, 9.2 ], 6);
        map.options.minZoom = 2;


    tiles = L.tileLayer('https://{s}.tiles.madavi.de/{z}/{x}/{y}.png',{
				attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
				maxZoom: 18}).addTo(map);


    
    window.onload=function(){
                
       d3.queue()
    .defer(d3.json, "https://api.luftdaten.info/static/v2/data.dust.min.json")
    .defer(d3.json, "https://api.luftdaten.info/static/v2/data.temp.min.json")
    .awaitAll(ready); 
           
 
        map.on('moveend', function() { 
    if(hexahmtest == true){hexagonheatmap._zoomChange();};    

});
    

map.on('zoomend', function() {
if(hexahmtest == true){hexagonheatmap._zoomChange();};    
});
        
      
        
        
    };
    
    
    
  function ready(error,data) {
  if (error) throw error;
     
     
         data[0].forEach(function(item){
            
               var objecthexa ={"data":{"PM10": parseInt(getRightValue(item.sensordatavalues,"P1")) , "PM25":parseInt( getRightValue(item.sensordatavalues,"P2"))}, "id":item.sensor.id, "latitude":item.location.latitude,"longitude":item.location.longitude};
                
                var objectsensor = {"id":item.sensor.id, "display":item.sensor.id.toString(), "latitude":item.location.latitude,"longitude":item.location.longitude,"type":"PM"};
                                
            hmhexaPM.push(objecthexa); 
            arraySensors.push(objectsensor);
            arraySensors.sort(function(a,b) {return (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0);} );

            });
     
     
     
     data[1].forEach(function(item){
            
               var objecthexa ={"data":{"Temp": parseInt(getRightValue(item.sensordatavalues,"temperature")) , "Humi": parseInt(getRightValue(item.sensordatavalues,"humidity"))}, "id":item.sensor.id, "latitude":item.location.latitude,"longitude":item.location.longitude};
                
                var objectsensor = {"id":item.sensor.id, "display":item.sensor.id.toString(), "latitude":item.location.latitude,"longitude":item.location.longitude,"type":"TH"};
                                
            hmhexatemp.push(objecthexa);
            arraySensors.push(objectsensor);
            arraySensors.sort(function(a,b) {return (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0);} );

            });
      
      
      
      data[1].forEach(function(item){
            
          
          if(item.sensordatavalues.length == 3){
              
               var objecthexa ={"data":{"Press":parseInt(getRightValue(item.sensordatavalues,"pressure"))}, "id":item.sensor.id, "latitude":item.location.latitude,"longitude":item.location.longitude};
              
              var objectsensor = {"id":item.sensor.id, "display":item.sensor.id.toString(), "latitude":item.location.latitude,"longitude":item.location.longitude,"type":"P"};
                          
              hmhexadruck.push(objecthexa);
              arraySensorsDruck.push(objectsensor);
            arraySensorsDruck.sort(function(a,b) {return (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0);} );       
          };
            });
      
      
      
      
     
//     console.log(hmhexaPM);
//    console.log(arraySensors);
//         console.log(hmhexadruck);
//          console.log(arraySensorsDruck);



     makeHexagonmap(hmhexaPM);
        
 };      
    
    
        
function makeHexagonmap(data){

    
    
    if(selector == "hmPM10" || selector == "hmPM2.5" ){
    
    
    var options = {
                valueDomain: [20, 40, 60, 100, 500],
                colorRange: ['#00796B', '#F9A825', '#E65100', '#DD2C00', '#960084']	
                };
        
        
           hexahmtest = true;
                    hexagonheatmap = L.hexbinLayer(options).addTo(map);
                    hexagonheatmap.data(hmhexaPM); 

    };
    

        if(selector == "hmtemp" ){

    
     var options = {
                valueDomain: [-20, 0, 50],
                colorRange: ['#0022FE', '#FFFFFF', '#FF0000']	
            };
            
               hexahmtest = true;
                    hexagonheatmap = L.hexbinLayer(options).addTo(map);
                    hexagonheatmap.data(hmhexatemp); 
    
    
        };
    
    
            if(selector == "hmhumi" ){

            var options = {
                valueDomain: [0,100],
		      colorRange: ['#FFFFFF', '#0000FF']	
            };
    
               hexahmtest = true;
                    hexagonheatmap = L.hexbinLayer(options).addTo(map);
                    hexagonheatmap.data(hmhexatemp); 
                
            };
    
    
                  
    
    
    
    
    
     if(selector == "hmdruck" ){

            var options = {
               valueDomain: [90000, 101300, 110000],
                colorRange: ['#FF0000', '#FE9E01', '#00796B']	
            };
         
            hexahmtest = true;
                    hexagonheatmap = L.hexbinLayer(options).addTo(map);
                    hexagonheatmap.data(hmhexadruck); 
    
            };
    

                   

};
    
    
    

        function reload(val){
                        
            selector = val;
    
            if(selector == "hmPM10" || selector == "hmPM2.5" ){
            var options = {
            valueDomain: [20, 40, 60, 100, 500],
            colorRange: ['#00796B', '#F9A825', '#E65100', '#DD2C00', '#960084']	
            };
                
                
                 hexagonheatmap.initialize(options);
                hexagonheatmap.data(hmhexaPM);         
                
            };
    
        if(selector == "hmtemp" ){
        var options = {
                valueDomain: [-20, 0, 50],
                colorRange: ['#0022FE', '#FFFFFF', '#FF0000']	
            };
            
             hexagonheatmap.initialize(options);
                hexagonheatmap.data(hmhexatemp);         
            
            
        };
    
        if(selector == "hmhumi" ){
            var options = {
                valueDomain: [0,100],
		      colorRange: ['#FFFFFF', '#0000FF']	
            };
            
             hexagonheatmap.initialize(options);
                hexagonheatmap.data(hmhexatemp);         
            
            
            };
    
     if(selector == "hmdruck" ){
            var options = {
               valueDomain: [90000, 101300, 110000],
                colorRange: ['#FF0000', '#FE9E01', '#00796B']	
            };
         
         
          hexagonheatmap.initialize(options);
                hexagonheatmap.data(hmhexadruck);         
         
         
            };
            
            
                  
    };
    
    
    
    
    function getRightValue(array,type){
    var value;
    array.forEach(function(item){  
       if (item.value_type == type){value = item.value;};       
    });        
    return value;
};
    
  
    
    
    
    
    
    </script>
      
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-animate.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-aria.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-messages.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.4/angular-material.min.js"></script> 
    
<script type="text/javascript" src="appcomponents.js"></script> 
   
            
      
</body>
</html>

